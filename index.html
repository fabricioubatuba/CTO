<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Manutenção - CTO e Bairros</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background-color: #f5f5f5;
    }
    h2 { 
      margin-top: 30px; 
      color: #333;
    }
    input, button, select {
      padding: 10px; 
      margin: 8px 0; 
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background-color: #4285f4;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #3367d6;
    }
    #login-section, #supervisor-section, #atendente-section { 
      display: none; 
      max-width: 500px; 
      margin: 20px auto;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 15px;
      background: white;
    }
    th, td { 
      border: 1px solid #ddd; 
      padding: 10px; 
      text-align: left; 
    }
    th {
      background-color: #f2f2f2;
    }
    .modal {
      display: none; 
      position: fixed; 
      z-index: 9999;
      left: 0; 
      top: 0; 
      width: 100%; 
      height: 100%;
      background-color: rgba(0,0,0,0.6);
    }
    .modal-content {
      background-color: #fff; 
      margin: 5% auto; 
      padding: 20px;
      border-radius: 8px;
      width: 90%; 
      max-width: 600px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    #map { 
      height: 400px; 
      margin: 15px 0;
      border-radius: 4px;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    .error-message {
      color: #d32f2f;
      background: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      display: none;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <div id="login-section">
    <h2>Login</h2>
    <div id="login-error" class="error-message"></div>
    <input type="email" id="email" placeholder="E-mail" required />
    <input type="password" id="password" placeholder="Senha" required />
    <button onclick="login()">Entrar</button>
  </div>

  <div id="supervisor-section">
    <h2>Cadastro de CTO</h2>
    <div id="cto-error" class="error-message"></div>
    <input id="cto-nome" placeholder="Nome da CTO" required />
    <input id="cto-lat" placeholder="Latitude" type="number" step="0.000001" required />
    <input id="cto-lng" placeholder="Longitude" type="number" step="0.000001" required />
    <input id="cto-endereco" placeholder="Endereço" required />
    <input id="cto-numero" placeholder="Número" required />
    <input id="cto-bairro" placeholder="Bairro" required />
    <input id="cto-cidade" placeholder="Cidade" required />
    <select id="cto-status" required>
      <option value="" disabled selected>Selecione o status</option>
      <option value="Em manutenção">Em manutenção</option>
      <option value="Normal">Normal</option>
    </select>
    <button onclick="cadastrarCTO()">Cadastrar CTO</button>

    <h2>Cadastro de Bairro</h2>
    <div id="bairro-error" class="error-message"></div>
    <input id="bairro-nome" placeholder="Nome do Bairro" required />
    <input id="bairro-cidade" placeholder="Cidade" required />
    <select id="bairro-status" required>
      <option value="" disabled selected>Selecione o status</option>
      <option value="Em manutenção">Em manutenção</option>
      <option value="Normal">Normal</option>
    </select>
    <button onclick="cadastrarBairro()">Cadastrar Bairro</button>
  </div>

  <div id="atendente-section">
    <h2>CTOs em Manutenção</h2>
    <div id="loading-ctos" class="loading">Carregando CTOs...</div>
    <table id="tabela-ctos">
      <thead><tr><th>Nome</th><th>Bairro</th><th>Ação</th></tr></thead>
      <tbody></tbody>
    </table>

    <h2>Bairros em Manutenção</h2>
    <div id="loading-bairros" class="loading">Carregando bairros...</div>
    <table id="tabela-bairros">
      <thead><tr><th>Nome</th><th>Cidade</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modal do Mapa -->
  <div id="map-modal" class="modal">
    <div class="modal-content">
      <h3 id="map-titulo"></h3>
      <div id="map"></div>
      <button onclick="fecharMapa()">Fechar</button>
    </div>
  </div>

  <!-- Firebase e Leaflet -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    // Configuração do Firebase (com suas credenciais)
    const firebaseConfig = {
      apiKey: "AIzaSyDi5wK70cNr7tJJ55hFsw3vjrMbFtWdc24",
      authDomain: "ctos-efd7c.firebaseapp.com",
      databaseURL: "https://ctos-efd7c-default-rtdb.firebaseio.com",
      projectId: "ctos-efd7c",
      storageBucket: "ctos-efd7c.firebasestorage.app",
      messagingSenderId: "1061563628444",
      appId: "1:1061563628444:web:d008669dcc6ac935a82659"
    };

    // Inicialização do Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Lista de e-mails de supervisores
    const supervisorEmails = [
      "eduardo@sejafibra.com", 
      "junior@sejafibra.net", 
      "bioranss@gmail.com"
    ];

    // Variável para armazenar o mapa
    let map;

    // Função de login
    function login() {
      const email = document.getElementById('email').value;
      const senha = document.getElementById('password').value;
      const errorElement = document.getElementById('login-error');
      
      errorElement.style.display = 'none';
      
      if (!email || !senha) {
        showError(errorElement, 'Por favor, preencha todos os campos.');
        return;
      }

      auth.signInWithEmailAndPassword(email, senha)
        .then((userCred) => {
          const userEmail = userCred.user.email;
          document.getElementById('login-section').style.display = 'none';
          
          if (supervisorEmails.includes(userEmail)) {
            document.getElementById('supervisor-section').style.display = 'block';
          } else {
            document.getElementById('atendente-section').style.display = 'block';
            carregarTabelas();
          }
        })
        .catch((error) => {
          let errorMessage = "Erro ao entrar: ";
          switch (error.code) {
            case 'auth/invalid-email':
              errorMessage += 'E-mail inválido.';
              break;
            case 'auth/user-disabled':
              errorMessage += 'Conta desativada.';
              break;
            case 'auth/user-not-found':
            case 'auth/wrong-password':
              errorMessage += 'E-mail ou senha incorretos.';
              break;
            default:
              errorMessage += error.message;
          }
          showError(errorElement, errorMessage);
        });
    }

    // Função para cadastrar CTO
    function cadastrarCTO() {
      const errorElement = document.getElementById('cto-error');
      errorElement.style.display = 'none';
      
      const cto = {
        nome: document.getElementById('cto-nome').value,
        latitude: parseFloat(document.getElementById('cto-lat').value),
        longitude: parseFloat(document.getElementById('cto-lng').value),
        endereco: document.getElementById('cto-endereco').value,
        numero: document.getElementById('cto-numero').value,
        bairro: document.getElementById('cto-bairro').value,
        cidade: document.getElementById('cto-cidade').value,
        status: document.getElementById('cto-status').value
      };
      
      // Validação dos campos
      if (!cto.nome || !cto.endereco || !cto.numero || !cto.bairro || !cto.cidade || !cto.status) {
        showError(errorElement, 'Por favor, preencha todos os campos.');
        return;
      }
      
      if (isNaN(cto.latitude) {
        showError(errorElement, 'Latitude inválida.');
        return;
      }
      
      if (isNaN(cto.longitude)) {
        showError(errorElement, 'Longitude inválida.');
        return;
      }

      db.ref('ctos').push(cto)
        .then(() => {
          alert("CTO cadastrada com sucesso!");
          // Limpa os campos
          document.getElementById('cto-nome').value = '';
          document.getElementById('cto-lat').value = '';
          document.getElementById('cto-lng').value = '';
          document.getElementById('cto-endereco').value = '';
          document.getElementById('cto-numero').value = '';
          document.getElementById('cto-bairro').value = '';
          document.getElementById('cto-cidade').value = '';
          document.getElementById('cto-status').value = '';
        })
        .catch((error) => {
          showError(errorElement, 'Erro ao cadastrar CTO: ' + error.message);
        });
    }

    // Função para cadastrar Bairro
    function cadastrarBairro() {
      const errorElement = document.getElementById('bairro-error');
      errorElement.style.display = 'none';
      
      const bairro = {
        nome: document.getElementById('bairro-nome').value,
        cidade: document.getElementById('bairro-cidade').value,
        status: document.getElementById('bairro-status').value
      };
      
      // Validação dos campos
      if (!bairro.nome || !bairro.cidade || !bairro.status) {
        showError(errorElement, 'Por favor, preencha todos os campos.');
        return;
      }

      db.ref('bairros').push(bairro)
        .then(() => {
          alert("Bairro cadastrado com sucesso!");
          // Limpa os campos
          document.getElementById('bairro-nome').value = '';
          document.getElementById('bairro-cidade').value = '';
          document.getElementById('bairro-status').value = '';
        })
        .catch((error) => {
          showError(errorElement, 'Erro ao cadastrar bairro: ' + error.message);
        });
    }

    // Função para carregar as tabelas
    function carregarTabelas() {
      const ctosRef = db.ref('ctos');
      const bairrosRef = db.ref('bairros');
      
      document.getElementById('loading-ctos').style.display = 'block';
      document.getElementById('loading-bairros').style.display = 'block';
      
      ctosRef.on('value', (snapshot) => {
        const corpo = document.querySelector("#tabela-ctos tbody");
        corpo.innerHTML = '';
        
        if (!snapshot.exists()) {
          document.getElementById('loading-ctos').textContent = 'Nenhuma CTO em manutenção.';
          return;
        }
        
        document.getElementById('loading-ctos').style.display = 'none';
        
        snapshot.forEach((child) => {
          const cto = child.val();
          if (cto.status === "Em manutenção") {
            const linha = document.createElement('tr');
            linha.innerHTML = `
              <td>${cto.nome}</td>
              <td>${cto.bairro}</td>
              <td><button onclick='abrirMapa("${cto.nome}", ${cto.latitude}, ${cto.longitude})'>Ver no mapa</button></td>
            `;
            corpo.appendChild(linha);
          }
        });
      });

      bairrosRef.on('value', (snapshot) => {
        const corpo = document.querySelector("#tabela-bairros tbody");
        corpo.innerHTML = '';
        
        if (!snapshot.exists()) {
          document.getElementById('loading-bairros').textContent = 'Nenhum bairro em manutenção.';
          return;
        }
        
        document.getElementById('loading-bairros').style.display = 'none';
        
        snapshot.forEach((child) => {
          const bairro = child.val();
          if (bairro.status === "Em manutenção") {
            const linha = document.createElement('tr');
            linha.innerHTML = `<td>${bairro.nome}</td><td>${bairro.cidade}</td>`;
            corpo.appendChild(linha);
          }
        });
      });
    }

    // Função para abrir o mapa
    function abrirMapa(nome, lat, lng) {
      document.getElementById('map-titulo').innerText = nome;
      document.getElementById('map-modal').style.display = 'block';
      
      // Destrói o mapa existente se houver
      if (map) {
        map.remove();
      }
      
      // Cria um novo mapa
      setTimeout(() => {
        map = L.map('map').setView([lat, lng], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        L.marker([lat, lng]).addTo(map)
          .bindPopup(nome)
          .openPopup();
      }, 100);
    }

    // Função para fechar o mapa
    function fecharMapa() {
      document.getElementById('map-modal').style.display = 'none';
      if (map) {
        map.remove();
        map = null;
      }
    }

    // Função para exibir mensagens de erro
    function showError(element, message) {
      element.textContent = message;
      element.style.display = 'block';
    }

    // Inicialização da página
    window.onload = () => {
      document.getElementById('login-section').style.display = 'block';
      
      // Verifica se o usuário já está logado
      auth.onAuthStateChanged((user) => {
        if (user) {
          document.getElementById('login-section').style.display = 'none';
          if (supervisorEmails.includes(user.email)) {
            document.getElementById('supervisor-section').style.display = 'block';
          } else {
            document.getElementById('atendente-section').style.display = 'block';
            carregarTabelas();
          }
        }
      });
    };
  </script>
</body>
</html>
