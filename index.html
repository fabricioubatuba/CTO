<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Manutenção - CTO e Bairros</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0;
      padding: 20px; 
      background-color: #f5f5f5;
    }
    h2 { 
      margin-top: 30px; 
      color: #333;
    }
    input, button, select {
      padding: 10px; 
      margin: 8px 0; 
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background-color: #4285f4;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #3367d6;
    }
    button.secondary {
      background-color: #f1f1f1;
      color: #333;
    }
    button.danger {
      background-color: #d32f2f;
    }
    button.warning {
      background-color: #ffa000;
    }
    button.success {
      background-color: #388e3c;
    }
    #login-section, #supervisor-section, #atendente-section, #tecnico-section { 
      display: none; 
      max-width: 800px; 
      margin: 20px auto;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 15px;
      background: white;
    }
    th, td { 
      border: 1px solid #ddd; 
      padding: 10px; 
      text-align: left; 
    }
    th {
      background-color: #f2f2f2;
    }
    .modal {
      display: none; 
      position: fixed; 
      z-index: 9999;
      left: 0; 
      top: 0; 
      width: 100%; 
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      overflow: auto;
    }
    .modal-content {
      background-color: #fff; 
      margin: 10% auto; 
      padding: 20px;
      border-radius: 8px;
      width: 90%; 
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    #map { 
      height: 400px; 
      margin: 15px 0;
      border-radius: 4px;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    .error-message {
      color: #d32f2f;
      background: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      display: none;
    }
    .success-message {
      color: #388e3c;
      background: #e8f5e9;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      display: none;
    }
    .copy-message {
      color: #1976d2;
      background: #e3f2fd;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      display: none;
    }
    .warning-message {
      color: #ffa000;
      background: #fff8e1;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      display: none;
    }
    form {
      margin: 0;
    }
    .filters {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-bottom: 20px;
    }
    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 8px 15px;
      width: auto;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .header img {
      height: 50px;
    }
    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-buttons button {
      width: auto;
      padding: 10px 20px;
    }
    .tab-buttons button.active {
      background-color: #3367d6;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .status-info {
      font-size: 0.8em;
      color: #666;
      margin-top: 5px;
    }
    .status-overdue {
      color: #d32f2f;
      font-weight: bold;
    }
    #tempo-manutencao-container,
    #tempo-manutencao-container-tecnico,
    #tempo-manutencao-container-bairro,
    #tempo-manutencao-container-bairro-tecnico {
      margin: 10px 0;
    }
    #tempo-manutencao-container label,
    #tempo-manutencao-container-tecnico label,
    #tempo-manutencao-container-bairro label,
    #tempo-manutencao-container-bairro-tecnico label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <div id="login-section">
    <h2>Login</h2>
    <div id="login-error" class="error-message"></div>
    <form id="login-form" onsubmit="event.preventDefault(); login();">
      <input type="email" id="email" placeholder="E-mail" required />
      <input type="password" id="password" placeholder="Senha" required />
      <button type="submit">Entrar</button>
    </form>
  </div>

  <div id="supervisor-section">
    <button class="logout-btn" onclick="logout()">Sair</button>
    
    <div class="header">
      <h1>Painel do Supervisor</h1>
      <img src="https://raw.githubusercontent.com/fabricioubatuba/CTO/main/assets/supervisor.png" alt="Supervisor">
    </div>
    
    <div class="tab-buttons">
      <button onclick="openTab('bairros-tab')">Bairros</button>
      <button class="active" onclick="openTab('ctos-tab')">CTOs</button>
    </div>
    
    <div id="ctos-tab" class="tab-content active">
      <div class="action-buttons">
        <button onclick="abrirModalCadastroCTO()">Cadastrar CTO</button>
      </div>
      
      <div class="filters">
        <h3>Filtrar CTOs</h3>
        <select id="filtro-status-cto" onchange="filtrarCTOs()">
          <option value="Todos">Todos os status</option>
          <option value="Em manutenção">Em manutenção</option>
          <option value="Normal">Normal</option>
        </select>
      </div>
      
      <div id="loading-ctos" class="loading">Carregando CTOs...</div>
      <div id="success-cto" class="success-message"></div>
      <div id="error-cto" class="error-message"></div>
      <div id="copy-message-cto" class="copy-message"></div>
      
      <table id="tabela-ctos">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Bairro</th>
            <th>Cidade</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <div id="bairros-tab" class="tab-content">
      <div class="action-buttons">
        <button onclick="abrirModalCadastroBairro()">Cadastrar Bairro</button>
      </div>
      
      <div class="filters">
        <h3>Filtrar Bairros</h3>
        <select id="filtro-status-bairro" onchange="filtrarBairros()">
          <option value="Todos">Todos os status</option>
          <option value="Em manutenção">Em manutenção</option>
          <option value="Normal">Normal</option>
        </select>
      </div>
      
      <div id="loading-bairros" class="loading">Carregando bairros...</div>
      <div id="success-bairro" class="success-message"></div>
      <div id="error-bairro" class="error-message"></div>
      <div id="copy-message-bairro" class="copy-message"></div>
      
      <table id="tabela-bairros">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Cidade</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="atendente-section">
    <button class="logout-btn" onclick="logout()">Sair</button>
    
    <div class="header">
      <h1>Painel do Atendente</h1>
      <img src="https://raw.githubusercontent.com/fabricioubatuba/CTO/main/assets/atendente.png" alt="Atendente">
    </div>
    
    <div class="tab-buttons">
      <button onclick="openTab('bairros-tab-atendente')">Bairros</button>
      <button class="active" onclick="openTab('ctos-tab-atendente')">CTOs</button>
    </div>
    
    <div id="ctos-tab-atendente" class="tab-content active">
      <div class="filters">
        <h3>Filtrar CTOs</h3>
        <select id="filtro-status-cto-atendente" onchange="filtrarCTOsAtendente()">
          <option value="Todos">Todos os status</option>
          <option value="Em manutenção">Em manutenção</option>
          <option value="Normal">Normal</option>
        </select>
      </div>
      
      <div id="loading-ctos-atendente" class="loading">Carregando CTOs...</div>
      <div id="copy-message-cto-atendente" class="copy-message"></div>
      
      <table id="tabela-ctos-atendente">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Bairro</th>
            <th>Cidade</th>
            <th>Status</th>
            <th>Ação</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <div id="bairros-tab-atendente" class="tab-content">
      <div class="filters">
        <h3>Filtrar Bairros</h3>
        <select id="filtro-status-bairro-atendente" onchange="filtrarBairrosAtendente()">
          <option value="Todos">Todos os status</option>
          <option value="Em manutenção">Em manutenção</option>
          <option value="Normal">Normal</option>
        </select>
      </div>
      
      <div id="loading-bairros-atendente" class="loading">Carregando bairros...</div>
      <div id="copy-message-bairro-atendente" class="copy-message"></div>
      
      <table id="tabela-bairros-atendente">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Cidade</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="tecnico-section">
    <button class="logout-btn" onclick="logout()">Sair</button>
    
    <div class="header">
      <h1>Painel do Técnico</h1>
      <img src="https://raw.githubusercontent.com/fabricioubatuba/CTO/main/assets/tecnico.png" alt="Técnico">
    </div>
    
    <div class="tab-buttons">
      <button onclick="openTab('bairros-tab-tecnico')">Bairros</button>
      <button class="active" onclick="openTab('ctos-tab-tecnico')">CTOs</button>
    </div>
    
    <div id="ctos-tab-tecnico" class="tab-content active">
      <div class="filters">
        <h3>Filtrar CTOs</h3>
        <select id="filtro-status-cto-tecnico" onchange="filtrarCTOsTecnico()">
          <option value="Todos">Todos os status</option>
          <option value="Em manutenção">Em manutenção</option>
          <option value="Normal">Normal</option>
        </select>
      </div>
      
      <div id="loading-ctos-tecnico" class="loading">Carregando CTOs...</div>
      <div id="success-cto-tecnico" class="success-message"></div>
      <div id="error-cto-tecnico" class="error-message"></div>
      <div id="copy-message-cto-tecnico" class="copy-message"></div>
      
      <table id="tabela-ctos-tecnico">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Bairro</th>
            <th>Cidade</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <div id="bairros-tab-tecnico" class="tab-content">
      <div class="filters">
        <h3>Filtrar Bairros</h3>
        <select id="filtro-status-bairro-tecnico" onchange="filtrarBairrosTecnico()">
          <option value="Todos">Todos os status</option>
          <option value="Em manutenção">Em manutenção</option>
          <option value="Normal">Normal</option>
        </select>
      </div>
      
      <div id="loading-bairros-tecnico" class="loading">Carregando bairros...</div>
      <div id="success-bairro-tecnico" class="success-message"></div>
      <div id="error-bairro-tecnico" class="error-message"></div>
      <div id="copy-message-bairro-tecnico" class="copy-message"></div>
      
      <table id="tabela-bairros-tecnico">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Cidade</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modal Cadastro CTO -->
  <div id="modal-cto" class="modal">
    <div class="modal-content">
      <h3 id="modal-cto-titulo">Cadastrar CTO</h3>
      <div id="cto-modal-error" class="error-message"></div>
      <form id="cto-form">
        <input id="cto-id" type="hidden">
        <input id="cto-nome" placeholder="Nome da CTO" required />
        <input id="cto-lat" placeholder="Latitude" type="number" step="0.000001" required />
        <input id="cto-lng" placeholder="Longitude" type="number" step="0.000001" required />
        <input id="cto-endereco" placeholder="Endereço" required />
        <input id="cto-numero" placeholder="Número" required />
        <input id="cto-bairro" placeholder="Bairro" required />
        <input id="cto-cidade" placeholder="Cidade" required />
        <select id="cto-status" required onchange="mostrarTempoManutencao(this.value)">
          <option value="" disabled selected>Selecione o status</option>
          <option value="Em manutenção">Em manutenção</option>
          <option value="Normal">Normal</option>
        </select>
        <div id="tempo-manutencao-container" style="display: none;">
          <label for="cto-tempo-manutencao">Tempo estimado para manutenção:</label>
          <select id="cto-tempo-manutencao">
            <option value="30">30 minutos</option>
            <option value="60">1 hora</option>
            <option value="120">2 horas</option>
            <option value="180">3 horas</option>
            <option value="240" selected>4 horas</option>
          </select>
        </div>
        <div class="action-buttons">
          <button type="button" class="secondary" onclick="fecharModal('modal-cto')">Cancelar</button>
          <button type="button" onclick="salvarCTO()">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Edição Status CTO (para técnico) -->
  <div id="modal-cto-status" class="modal">
    <div class="modal-content">
      <h3 id="modal-cto-status-titulo">Editar Status da CTO</h3>
      <div id="cto-status-modal-error" class="error-message"></div>
      <form id="cto-status-form">
        <input id="cto-status-id" type="hidden">
        <input id="cto-status-nome" placeholder="Nome da CTO" readonly />
        <select id="cto-status-status" required onchange="mostrarTempoManutencaoTecnico(this.value)">
          <option value="" disabled selected>Selecione o status</option>
          <option value="Em manutenção">Em manutenção</option>
          <option value="Normal">Normal</option>
        </select>
        <div id="tempo-manutencao-container-tecnico" style="display: none;">
          <label for="cto-tempo-manutencao-tecnico">Tempo estimado para manutenção:</label>
          <select id="cto-tempo-manutencao-tecnico">
            <option value="30">30 minutos</option>
            <option value="60">1 hora</option>
            <option value="120">2 horas</option>
            <option value="180">3 horas</option>
            <option value="240" selected>4 horas</option>
          </select>
        </div>
        <div class="action-buttons">
          <button type="button" class="secondary" onclick="fecharModal('modal-cto-status')">Cancelar</button>
          <button type="button" onclick="salvarStatusCTO()">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Cadastro Bairro -->
  <div id="modal-bairro" class="modal">
    <div class="modal-content">
      <h3 id="modal-bairro-titulo">Cadastrar Bairro</h3>
      <div id="bairro-modal-error" class="error-message"></div>
      <form id="bairro-form">
        <input id="bairro-id" type="hidden">
        <input id="bairro-nome" placeholder="Nome do Bairro" required />
        <input id="bairro-cidade" placeholder="Cidade" required />
        <select id="bairro-status" required onchange="mostrarTempoManutencaoBairro(this.value)">
          <option value="" disabled selected>Selecione o status</option>
          <option value="Em manutenção">Em manutenção</option>
          <option value="Normal">Normal</option>
        </select>
        <div id="tempo-manutencao-container-bairro" style="display: none;">
          <label for="bairro-tempo-manutencao">Tempo estimado para manutenção:</label>
          <select id="bairro-tempo-manutencao">
            <option value="30">30 minutos</option>
            <option value="60">1 hora</option>
            <option value="120">2 horas</option>
            <option value="180">3 horas</option>
            <option value="240" selected>4 horas</option>
          </select>
        </div>
        <div class="action-buttons">
          <button type="button" class="secondary" onclick="fecharModal('modal-bairro')">Cancelar</button>
          <button type="button" onclick="salvarBairro()">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Edição Status Bairro (para técnico) -->
  <div id="modal-bairro-status" class="modal">
    <div class="modal-content">
      <h3 id="modal-bairro-status-titulo">Editar Status do Bairro</h3>
      <div id="bairro-status-modal-error" class="error-message"></div>
      <form id="bairro-status-form">
        <input id="bairro-status-id" type="hidden">
        <input id="bairro-status-nome" placeholder="Nome do Bairro" readonly />
        <select id="bairro-status-status" required onchange="mostrarTempoManutencaoBairroTecnico(this.value)">
          <option value="" disabled selected>Selecione o status</option>
          <option value="Em manutenção">Em manutenção</option>
          <option value="Normal">Normal</option>
        </select>
        <div id="tempo-manutencao-container-bairro-tecnico" style="display: none;">
          <label for="bairro-tempo-manutencao-tecnico">Tempo estimado para manutenção:</label>
          <select id="bairro-tempo-manutencao-tecnico">
            <option value="30">30 minutos</option>
            <option value="60">1 hora</option>
            <option value="120">2 horas</option>
            <option value="180">3 horas</option>
            <option value="240" selected>4 horas</option>
          </select>
        </div>
        <div class="action-buttons">
          <button type="button" class="secondary" onclick="fecharModal('modal-bairro-status')">Cancelar</button>
          <button type="button" onclick="salvarStatusBairro()">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal do Mapa -->
  <div id="map-modal" class="modal">
    <div class="modal-content">
      <h3 id="map-titulo"></h3>
      <div id="map"></div>
      <button onclick="fecharModal('map-modal')">Fechar</button>
    </div>
  </div>

  <!-- Firebase (versão compatível) e Leaflet -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    // Configuração do Firebase (com suas credenciais)
    const firebaseConfig = {
      apiKey: "AIzaSyDi5wK70cNr7tJJ55hFsw3vjrMbFtWdc24",
      authDomain: "ctos-efd7c.firebaseapp.com",
      databaseURL: "https://ctos-efd7c-default-rtdb.firebaseio.com",
      projectId: "ctos-efd7c",
      storageBucket: "ctos-efd7c.firebasestorage.app",
      messagingSenderId: "1061563628444",
      appId: "1:1061563628444:web:d008669dcc6ac935a82659"
    };

    // Inicialização do Firebase (versão compatível)
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Lista de e-mails autorizados
    const supervisorEmails = ["supervisor@sejafibra.net"];
    const atendenteEmails = ["atendente@sejafibra.net"];
    const tecnicoEmails = ["tecnico@sejafibra.net"];
    
    // Variável para armazenar o mapa
    let map;
    let ctoEditando = null;
    let bairroEditando = null;

    // Função para mostrar/ocultar campo de tempo de manutenção
    function mostrarTempoManutencao(status) {
      const container = document.getElementById('tempo-manutencao-container');
      container.style.display = status === 'Em manutenção' ? 'block' : 'none';
    }

    function mostrarTempoManutencaoTecnico(status) {
      const container = document.getElementById('tempo-manutencao-container-tecnico');
      container.style.display = status === 'Em manutenção' ? 'block' : 'none';
    }

    function mostrarTempoManutencaoBairro(status) {
      const container = document.getElementById('tempo-manutencao-container-bairro');
      container.style.display = status === 'Em manutenção' ? 'block' : 'none';
    }

    function mostrarTempoManutencaoBairroTecnico(status) {
      const container = document.getElementById('tempo-manutencao-container-bairro-tecnico');
      container.style.display = status === 'Em manutenção' ? 'block' : 'none';
    }

    // Função para verificar se a manutenção está atrasada
    function verificarManutencaoAtrasada(previsaoTermino) {
      if (!previsaoTermino) return false;
      const agora = new Date();
      const previsao = new Date(previsaoTermino);
      return agora > previsao;
    }

    // Função para formatar data/hora
    function formatarDataHora(data) {
      if (!data) return '';
      const d = new Date(data);
      return d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    }

    // Função para copiar mensagem para área de transferência
    function copiarMensagemParaClipboard(entidade, nome, novoStatus, previsaoTermino, elementId) {
      const agora = new Date();
      let mensagem;
      
      if (novoStatus === "Em manutenção") {
        if (!previsaoTermino) {
          console.error('Previsão de término não definida para status "Em manutenção"');
          return;
        }
        const horaPrevisao = formatarDataHora(previsaoTermino);
        mensagem = `${entidade} ${nome} Em Manutenção. Previsão de término às ${horaPrevisao}`;
      } else if (novoStatus === "Normal") {
        const horaAtual = agora.getHours().toString().padStart(2, '0');
        const minutoAtual = agora.getMinutes().toString().padStart(2, '0');
        mensagem = `${entidade} ${nome} Normal. Resolvido às ${horaAtual}:${minutoAtual}`;
      } else {
        return; // Não copia mensagem para outros status
      }
      
      // Copia para a área de transferência
      navigator.clipboard.writeText(mensagem).then(() => {
        const copyElement = document.getElementById(elementId);
        copyElement.textContent = 'Mensagem copiada para a área de transferência!';
        copyElement.style.display = 'block';
        setTimeout(() => copyElement.style.display = 'none', 3000);
      }).catch((error) => {
        console.error('Erro ao copiar mensagem:', error);
      });
    }

    // Função de login
    function login() {
      const email = document.getElementById('email').value;
      const senha = document.getElementById('password').value;
      const errorElement = document.getElementById('login-error');
      
      errorElement.style.display = 'none';
      
      if (!email || !senha) {
        showError(errorElement, 'Por favor, preencha todos os campos.');
        return;
      }

      auth.signInWithEmailAndPassword(email, senha)
        .then((userCred) => {
          const userEmail = userCred.user.email;
          document.getElementById('login-section').style.display = 'none';
          
          if (supervisorEmails.includes(userEmail)) {
            document.getElementById('supervisor-section').style.display = 'block';
            carregarTabelasSupervisor();
          } else if (atendenteEmails.includes(userEmail)) {
            document.getElementById('atendente-section').style.display = 'block';
            carregarTabelasAtendente();
          } else if (tecnicoEmails.includes(userEmail)) {
            document.getElementById('tecnico-section').style.display = 'block';
            carregarTabelasTecnico();
          } else {
            logout();
            showError(errorElement, 'Acesso não autorizado para este e-mail.');
          }
        })
        .catch((error) => {
          let errorMessage = "Erro ao entrar: ";
          switch (error.code) {
            case 'auth/invalid-email':
              errorMessage += 'E-mail inválido.';
              break;
            case 'auth/user-disabled':
              errorMessage += 'Conta desativada.';
              break;
            case 'auth/user-not-found':
            case 'auth/wrong-password':
              errorMessage += 'E-mail ou senha incorretos.';
              break;
            default:
              errorMessage += error.message;
          }
          showError(errorElement, errorMessage);
        });
    }

    // Função de logout
    function logout() {
      auth.signOut().then(() => {
        document.getElementById('supervisor-section').style.display = 'none';
        document.getElementById('atendente-section').style.display = 'none';
        document.getElementById('tecnico-section').style.display = 'none';
        document.getElementById('login-section').style.display = 'block';
        document.getElementById('login-form').reset();
      });
    }

    // Função para abrir modal de cadastro de CTO
    function abrirModalCadastroCTO() {
      document.getElementById('modal-cto-titulo').textContent = 'Cadastrar CTO';
      document.getElementById('cto-form').reset();
      document.getElementById('cto-id').value = '';
      document.getElementById('tempo-manutencao-container').style.display = 'none';
      ctoEditando = null;
      document.getElementById('modal-cto').style.display = 'block';
    }

    // Função para abrir modal de edição de CTO
    function editarCTO(id, cto) {
      document.getElementById('modal-cto-titulo').textContent = 'Editar CTO';
      document.getElementById('cto-id').value = id;
      document.getElementById('cto-nome').value = cto.nome;
      document.getElementById('cto-lat').value = cto.latitude;
      document.getElementById('cto-lng').value = cto.longitude;
      document.getElementById('cto-endereco').value = cto.endereco;
      document.getElementById('cto-numero').value = cto.numero;
      document.getElementById('cto-bairro').value = cto.bairro;
      document.getElementById('cto-cidade').value = cto.cidade;
      document.getElementById('cto-status').value = cto.status;
      
      // Mostra/oculta o campo de tempo de manutenção conforme o status
      mostrarTempoManutencao(cto.status);
      
      ctoEditando = {id, ...cto};
      document.getElementById('modal-cto').style.display = 'block';
    }

    // Função para abrir modal de edição de status da CTO (para técnico)
    function editarStatusCTO(id, cto) {
      document.getElementById('modal-cto-status-titulo').textContent = 'Editar Status da CTO';
      document.getElementById('cto-status-id').value = id;
      document.getElementById('cto-status-nome').value = cto.nome;
      document.getElementById('cto-status-status').value = cto.status;
      
      // Mostra/oculta o campo de tempo de manutenção conforme o status
      mostrarTempoManutencaoTecnico(cto.status);
      
      document.getElementById('modal-cto-status').style.display = 'block';
    }

    // Função para salvar CTO (criação ou edição)
    function salvarCTO() {
      const errorElement = document.getElementById('cto-modal-error');
      errorElement.style.display = 'none';
      
      const id = document.getElementById('cto-id').value;
      const status = document.getElementById('cto-status').value;
      const tempoManutencao = status === 'Em manutenção' ? 
        parseInt(document.getElementById('cto-tempo-manutencao').value) : null;
      
      // Calcula a previsão de término se estiver em manutenção
      let previsaoTermino = null;
      if (status === 'Em manutenção' && tempoManutencao) {
        const agora = new Date();
        previsaoTermino = new Date(agora.getTime() + tempoManutencao * 60 * 1000).toISOString();
      }
      
      const cto = {
        nome: document.getElementById('cto-nome').value,
        latitude: parseFloat(document.getElementById('cto-lat').value),
        longitude: parseFloat(document.getElementById('cto-lng').value),
        endereco: document.getElementById('cto-endereco').value,
        numero: document.getElementById('cto-numero').value,
        bairro: document.getElementById('cto-bairro').value,
        cidade: document.getElementById('cto-cidade').value,
        status: status,
        previsaoTermino: previsaoTermino
      };
      
      // Validação dos campos
      if (!cto.nome || !cto.endereco || !cto.numero || !cto.bairro || !cto.cidade || !cto.status) {
        showError(errorElement, 'Por favor, preencha todos os campos.');
        return;
      }
      
      if (isNaN(cto.latitude)) {
        showError(errorElement, 'Latitude inválida.');
        return;
      }
      
      if (isNaN(cto.longitude)) {
        showError(errorElement, 'Longitude inválida.');
        return;
      }

      // Verifica se o usuário está autenticado
      if (!auth.currentUser) {
        showError(errorElement, 'Você precisa estar logado para cadastrar.');
        return;
      }

      let promise;
      if (id) {
        // Edição
        promise = db.ref(`ctos/${id}`).update(cto);
      } else {
        // Cadastro novo
        promise = db.ref('ctos').push(cto);
      }

      promise
        .then(() => {
          const successElement = document.getElementById('success-cto');
          successElement.textContent = id ? 'CTO atualizada com sucesso!' : 'CTO cadastrada com sucesso!';
          successElement.style.display = 'block';
          setTimeout(() => successElement.style.display = 'none', 3000);
          
          // Copia mensagem para área de transferência
          if (status === 'Em manutenção' || (ctoEditando && ctoEditando.status !== cto.status)) {
            copiarMensagemParaClipboard("CTO", cto.nome, cto.status, previsaoTermino, 'copy-message-cto');
          }
          
          fecharModal('modal-cto');
          carregarTabelasSupervisor();
        })
        .catch((error) => {
          let errorMessage = 'Erro ao salvar: ';
          if (error.code === 'PERMISSION_DENIED') {
            errorMessage += 'Sem permissão. Verifique se você está logado com um e-mail autorizado.';
          } else {
            errorMessage += error.message;
          }
          showError(errorElement, errorMessage);
        });
    }

    // Função para salvar apenas o status da CTO (para técnico)
    function salvarStatusCTO() {
      const errorElement = document.getElementById('cto-status-modal-error');
      errorElement.style.display = 'none';
      
      const id = document.getElementById('cto-status-id').value;
      const nomeCTO = document.getElementById('cto-status-nome').value;
      const status = document.getElementById('cto-status-status').value;
      const tempoManutencao = status === 'Em manutenção' ? 
        parseInt(document.getElementById('cto-tempo-manutencao-tecnico').value) : null;
      
      // Calcula a previsão de término se estiver em manutenção
      let previsaoTermino = null;
      if (status === 'Em manutenção' && tempoManutencao) {
        const agora = new Date();
        previsaoTermino = new Date(agora.getTime() + tempoManutencao * 60 * 1000).toISOString();
      }
      
      if (!status) {
        showError(errorElement, 'Por favor, selecione um status.');
        return;
      }

      const updates = {
        status: status,
        previsaoTermino: previsaoTermino
      };

      db.ref(`ctos/${id}`).update(updates)
        .then(() => {
          const successElement = document.getElementById('success-cto-tecnico');
          successElement.textContent = 'Status da CTO atualizado com sucesso!';
          successElement.style.display = 'block';
          setTimeout(() => successElement.style.display = 'none', 3000);
          
          // Copia mensagem para área de transferência
          copiarMensagemParaClipboard("CTO", nomeCTO, status, previsaoTermino, 'copy-message-cto-tecnico');
          
          fecharModal('modal-cto-status');
          carregarTabelasTecnico();
        })
        .catch((error) => {
          showError(errorElement, 'Erro ao atualizar status: ' + error.message);
        });
    }

    // Função para excluir CTO
    function excluirCTO(id) {
      if (confirm('Tem certeza que deseja excluir esta CTO?')) {
        db.ref(`ctos/${id}`).remove()
          .then(() => {
            const successElement = document.getElementById('success-cto');
            successElement.textContent = 'CTO excluída com sucesso!';
            successElement.style.display = 'block';
            setTimeout(() => successElement.style.display = 'none', 3000);
            carregarTabelasSupervisor();
          })
          .catch((error) => {
            const errorElement = document.getElementById('error-cto');
            showError(errorElement, 'Erro ao excluir CTO: ' + error.message);
          });
      }
    }

    // Função para abrir modal de cadastro de bairro
    function abrirModalCadastroBairro() {
      document.getElementById('modal-bairro-titulo').textContent = 'Cadastrar Bairro';
      document.getElementById('bairro-form').reset();
      document.getElementById('bairro-id').value = '';
      document.getElementById('tempo-manutencao-container-bairro').style.display = 'none';
      bairroEditando = null;
      document.getElementById('modal-bairro').style.display = 'block';
    }

    // Função para editar bairro
    function editarBairro(id, bairro) {
      document.getElementById('modal-bairro-titulo').textContent = 'Editar Bairro';
      document.getElementById('bairro-id').value = id;
      document.getElementById('bairro-nome').value = bairro.nome;
      document.getElementById('bairro-cidade').value = bairro.cidade;
      document.getElementById('bairro-status').value = bairro.status;
      
      // Mostra/oculta o campo de tempo de manutenção conforme o status
      mostrarTempoManutencaoBairro(bairro.status);
      
      bairroEditando = {id, ...bairro};
      document.getElementById('modal-bairro').style.display = 'block';
    }

    // Função para editar status do bairro (para técnico)
    function editarStatusBairro(id, bairro) {
      document.getElementById('modal-bairro-status-titulo').textContent = 'Editar Status do Bairro';
      document.getElementById('bairro-status-id').value = id;
      document.getElementById('bairro-status-nome').value = bairro.nome;
      document.getElementById('bairro-status-status').value = bairro.status;
      
      // Mostra/oculta o campo de tempo de manutenção conforme o status
      mostrarTempoManutencaoBairroTecnico(bairro.status);
      
      document.getElementById('modal-bairro-status').style.display = 'block';
    }

    // Função para salvar bairro (criação ou edição)
    function salvarBairro() {
      const errorElement = document.getElementById('bairro-modal-error');
      errorElement.style.display = 'none';
      
      const id = document.getElementById('bairro-id').value;
      const status = document.getElementById('bairro-status').value;
      const tempoManutencao = status === 'Em manutenção' ? 
        parseInt(document.getElementById('bairro-tempo-manutencao').value) : null;
      
      // Calcula a previsão de término se estiver em manutenção
      let previsaoTermino = null;
      if (status === 'Em manutenção' && tempoManutencao) {
        const agora = new Date();
        previsaoTermino = new Date(agora.getTime() + tempoManutencao * 60 * 1000).toISOString();
      }
      
      const bairro = {
        nome: document.getElementById('bairro-nome').value,
        cidade: document.getElementById('bairro-cidade').value,
        status: status,
        previsaoTermino: previsaoTermino
      };
      
      // Validação dos campos
      if (!bairro.nome || !bairro.cidade || !bairro.status) {
        showError(errorElement, 'Por favor, preencha todos os campos.');
        return;
      }

      let promise;
      if (id) {
        // Edição
        promise = db.ref(`bairros/${id}`).update(bairro);
      } else {
        // Cadastro novo
        promise = db.ref('bairros').push(bairro);
      }

      promise
        .then(() => {
          const successElement = document.getElementById('success-bairro');
          successElement.textContent = id ? 'Bairro atualizado com sucesso!' : 'Bairro cadastrado com sucesso!';
          successElement.style.display = 'block';
          setTimeout(() => successElement.style.display = 'none', 3000);
          
          // Copia mensagem para área de transferência
          if (status === 'Em manutenção' || (bairroEditando && bairroEditando.status !== bairro.status)) {
            copiarMensagemParaClipboard("Bairro", bairro.nome, bairro.status, previsaoTermino, 'copy-message-bairro');
          }
          
          fecharModal('modal-bairro');
          carregarTabelasSupervisor();
        })
        .catch((error) => {
          showError(errorElement, 'Erro ao salvar bairro: ' + error.message);
        });
    }

    // Função para salvar apenas o status do bairro (para técnico)
    function salvarStatusBairro() {
      const errorElement = document.getElementById('bairro-status-modal-error');
      errorElement.style.display = 'none';
      
      const id = document.getElementById('bairro-status-id').value;
      const nomeBairro = document.getElementById('bairro-status-nome').value;
      const status = document.getElementById('bairro-status-status').value;
      const tempoManutencao = status === 'Em manutenção' ? 
        parseInt(document.getElementById('bairro-tempo-manutencao-tecnico').value) : null;
      
      // Calcula a previsão de término se estiver em manutenção
      let previsaoTermino = null;
      if (status === 'Em manutenção' && tempoManutencao) {
        const agora = new Date();
        previsaoTermino = new Date(agora.getTime() + tempoManutencao * 60 * 1000).toISOString();
      }
      
      if (!status) {
        showError(errorElement, 'Por favor, selecione um status.');
        return;
      }

      const updates = {
        status: status,
        previsaoTermino: previsaoTermino
      };

      db.ref(`bairros/${id}`).update(updates)
        .then(() => {
          const successElement = document.getElementById('success-bairro-tecnico');
          successElement.textContent = 'Status do bairro atualizado com sucesso!';
          successElement.style.display = 'block';
          setTimeout(() => successElement.style.display = 'none', 3000);
          
          // Copia mensagem para área de transferência
          copiarMensagemParaClipboard("Bairro", nomeBairro, status, previsaoTermino, 'copy-message-bairro-tecnico');
          
          fecharModal('modal-bairro-status');
          carregarTabelasTecnico();
        })
        .catch((error) => {
          showError(errorElement, 'Erro ao atualizar status: ' + error.message);
        });
    }

    // Função para excluir bairro
    function excluirBairro(id) {
      if (confirm('Tem certeza que deseja excluir este bairro?')) {
        db.ref(`bairros/${id}`).remove()
          .then(() => {
            const successElement = document.getElementById('success-bairro');
            successElement.textContent = 'Bairro excluído com sucesso!';
            successElement.style.display = 'block';
            setTimeout(() => successElement.style.display = 'none', 3000);
            carregarTabelasSupervisor();
          })
          .catch((error) => {
            const errorElement = document.getElementById('error-bairro');
            showError(errorElement, 'Erro ao excluir bairro: ' + error.message);
          });
      }
    }

    // Função para carregar tabelas do supervisor
    function carregarTabelasSupervisor() {
      const ctosRef = db.ref('ctos');
      const bairrosRef = db.ref('bairros');
      
      document.getElementById('loading-ctos').style.display = 'block';
      document.getElementById('loading-bairros').style.display = 'block';
      
      ctosRef.on('value', (snapshot) => {
        const corpo = document.querySelector("#tabela-ctos tbody");
        corpo.innerHTML = '';
        
        if (!snapshot.exists()) {
          document.getElementById('loading-ctos').textContent = 'Nenhuma CTO cadastrada.';
          return;
        }
        
        document.getElementById('loading-ctos').style.display = 'none';
        
        snapshot.forEach((child) => {
          const cto = child.val();
          const atrasado = cto.status === 'Em manutenção' && verificarManutencaoAtrasada(cto.previsaoTermino);
          const statusClass = cto.status === 'Normal' ? 'success' : 
                            atrasado ? 'danger' : 'warning';
          
          const linha = document.createElement('tr');
          linha.innerHTML = `
            <td>${cto.nome}</td>
            <td>${cto.bairro}</td>
            <td>${cto.cidade}</td>
            <td>
              <button class="${statusClass}">${cto.status}</button>
              ${cto.status === 'Em manutenção' && cto.previsaoTermino ? 
                `<div class="status-info ${atrasado ? 'status-overdue' : ''}">
                  Previsão: ${formatarDataHora(cto.previsaoTermino)}
                  ${atrasado ? ' (Atrasada)' : ''}
                </div>` : ''}
            </td>
            <td>
              <button onclick='editarCTO("${child.key}", ${JSON.stringify(cto).replace(/"/g, '&quot;')})'>Editar</button>
              <button class="danger" onclick='excluirCTO("${child.key}")'>Excluir</button>
            </td>
          `;
          corpo.appendChild(linha);
        });
      });

      bairrosRef.on('value', (snapshot) => {
        const corpo = document.querySelector("#tabela-bairros tbody");
        corpo.innerHTML = '';
        
        if (!snapshot.exists()) {
          document.getElementById('loading-bairros').textContent = 'Nenhum bairro cadastrado.';
          return;
        }
        
        document.getElementById('loading-bairros').style.display = 'none';
        
        snapshot.forEach((child) => {
          const bairro = child.val();
          const atrasado = bairro.status === 'Em manutenção' && verificarManutencaoAtrasada(bairro.previsaoTermino);
          const statusClass = bairro.status === 'Normal' ? 'success' : 
                            atrasado ? 'danger' : 'warning';
          
          const linha = document.createElement('tr');
          linha.innerHTML = `
            <td>${bairro.nome}</td>
            <td>${bairro.cidade}</td>
            <td>
              <button class="${statusClass}">${bairro.status}</button>
              ${bairro.status === 'Em manutenção' && bairro.previsaoTermino ? 
                `<div class="status-info ${atrasado ? 'status-overdue' : ''}">
                  Previsão: ${formatarDataHora(bairro.previsaoTermino)}
                  ${atrasado ? ' (Atrasada)' : ''}
                </div>` : ''}
            </td>
            <td>
              <button onclick='editarBairro("${child.key}", ${JSON.stringify(bairro).replace(/"/g, '&quot;')})'>Editar</button>
              <button class="danger" onclick='excluirBairro("${child.key}")'>Excluir</button>
            </td>
          `;
          corpo.appendChild(linha);
        });
      });
    }

    // Função para filtrar CTOs (supervisor)
    function filtrarCTOs() {
      const status = document.getElementById('filtro-status-cto').value;
      const linhas = document.querySelectorAll("#tabela-ctos tbody tr");
      
      linhas.forEach(linha => {
        const linhaStatus = linha.cells[3].querySelector('button').textContent;
        if (status === "Todos" || linhaStatus === status) {
          linha.style.display = "";
        } else {
          linha.style.display = "none";
        }
      });
    }

    // Função para filtrar bairros (supervisor)
    function filtrarBairros() {
      const status = document.getElementById('filtro-status-bairro').value;
      const linhas = document.querySelectorAll("#tabela-bairros tbody tr");
      
      linhas.forEach(linha => {
        const linhaStatus = linha.cells[2].querySelector('button').textContent;
        if (status === "Todos" || linhaStatus === status) {
          linha.style.display = "";
        } else {
          linha.style.display = "none";
        }
      });
    }

    // Função para carregar tabelas do atendente
    function carregarTabelasAtendente() {
      const ctosRef = db.ref('ctos');
      const bairrosRef = db.ref('bairros');
      
      document.getElementById('loading-ctos-atendente').style.display = 'block';
      document.getElementById('loading-bairros-atendente').style.display = 'block';
      
      ctosRef.on('value', (snapshot) => {
        const corpo = document.querySelector("#tabela-ctos-atendente tbody");
        corpo.innerHTML = '';
        
        if (!snapshot.exists()) {
          document.getElementById('loading-ctos-atendente').textContent = 'Nenhuma CTO cadastrada.';
          return;
        }
        
        document.getElementById('loading-ctos-atendente').style.display = 'none';
        
        snapshot.forEach((child) => {
          const cto = child.val();
          const atrasado = cto.status === 'Em manutenção' && verificarManutencaoAtrasada(cto.previsaoTermino);
          const statusClass = cto.status === 'Normal' ? 'success' : 
                            atrasado ? 'danger' : 'warning';
          
          const linha = document.createElement('tr');
          linha.innerHTML = `
            <td>${cto.nome}</td>
            <td>${cto.bairro}</td>
            <td>${cto.cidade}</td>
            <td>
              <button class="${statusClass}">${cto.status}</button>
              ${cto.status === 'Em manutenção' && cto.previsaoTermino ? 
                `<div class="status-info ${atrasado ? 'status-overdue' : ''}">
                  Previsão: ${formatarDataHora(cto.previsaoTermino)}
                  ${atrasado ? ' (Atrasada)' : ''}
                </div>` : ''}
            </td>
            <td><button onclick='abrirMapa("${cto.nome}", ${cto.latitude}, ${cto.longitude})'>Ver no mapa</button></td>
          `;
          corpo.appendChild(linha);
        });
      });

      bairrosRef.on('value', (snapshot) => {
        const corpo = document.querySelector("#tabela-bairros-atendente tbody");
        corpo.innerHTML = '';
        
        if (!snapshot.exists()) {
          document.getElementById('loading-bairros-atendente').textContent = 'Nenhum bairro cadastrado.';
          return;
        }
        
        document.getElementById('loading-bairros-atendente').style.display = 'none';
        
        snapshot.forEach((child) => {
          const bairro = child.val();
          const atrasado = bairro.status === 'Em manutenção' && verificarManutencaoAtrasada(bairro.previsaoTermino);
          const statusClass = bairro.status === 'Normal' ? 'success' : 
                            atrasado ? 'danger' : 'warning';
          
          const linha = document.createElement('tr');
          linha.innerHTML = `
            <td>${bairro.nome}</td>
            <td>${bairro.cidade}</td>
            <td>
              <button class="${statusClass}">${bairro.status}</button>
              ${bairro.status === 'Em manutenção' && bairro.previsaoTermino ? 
                `<div class="status-info ${atrasado ? 'status-overdue' : ''}">
                  Previsão: ${formatarDataHora(bairro.previsaoTermino)}
                  ${atrasado ? ' (Atrasada)' : ''}
                </div>` : ''}
            </td>
          `;
          corpo.appendChild(linha);
        });
      });
    }

    // Função para filtrar CTOs (atendente)
    function filtrarCTOsAtendente() {
      const status = document.getElementById('filtro-status-cto-atendente').value;
      const linhas = document.querySelectorAll("#tabela-ctos-atendente tbody tr");
      
      linhas.forEach(linha => {
        const linhaStatus = linha.cells[3].querySelector('button').textContent;
        if (status === "Todos" || linhaStatus === status) {
          linha.style.display = "";
        } else {
          linha.style.display = "none";
        }
      });
    }

    // Função para filtrar bairros (atendente)
    function filtrarBairrosAtendente() {
      const status = document.getElementById('filtro-status-bairro-atendente').value;
      const linhas = document.querySelectorAll("#tabela-bairros-atendente tbody tr");
      
      linhas.forEach(linha => {
        const linhaStatus = linha.cells[2].querySelector('button').textContent;
        if (status === "Todos" || linhaStatus === status) {
          linha.style.display = "";
        } else {
          linha.style.display = "none";
        }
      });
    }

    // Função para carregar tabelas do técnico
    function carregarTabelasTecnico() {
      const ctosRef = db.ref('ctos');
      const bairrosRef = db.ref('bairros');
      
      document.getElementById('loading-ctos-tecnico').style.display = 'block';
      document.getElementById('loading-bairros-tecnico').style.display = 'block';
      
      ctosRef.on('value', (snapshot) => {
        const corpo = document.querySelector("#tabela-ctos-tecnico tbody");
        corpo.innerHTML = '';
        
        if (!snapshot.exists()) {
          document.getElementById('loading-ctos-tecnico').textContent = 'Nenhuma CTO cadastrada.';
          return;
        }
        
        document.getElementById('loading-ctos-tecnico').style.display = 'none';
        
        snapshot.forEach((child) => {
          const cto = child.val();
          const atrasado = cto.status === 'Em manutenção' && verificarManutencaoAtrasada(cto.previsaoTermino);
          const statusClass = cto.status === 'Normal' ? 'success' : 
                            atrasado ? 'danger' : 'warning';
          
          const linha = document.createElement('tr');
          linha.innerHTML = `
            <td>${cto.nome}</td>
            <td>${cto.bairro}</td>
            <td>${cto.cidade}</td>
            <td>
              <button class="${statusClass}">${cto.status}</button>
              ${cto.status === 'Em manutenção' && cto.previsaoTermino ? 
                `<div class="status-info ${atrasado ? 'status-overdue' : ''}">
                  Previsão: ${formatarDataHora(cto.previsaoTermino)}
                  ${atrasado ? ' (Atrasada)' : ''}
                </div>` : ''}
            </td>
            <td>
              <button onclick='editarStatusCTO("${child.key}", ${JSON.stringify(cto).replace(/"/g, '&quot;')})'>Editar Status</button>
            </td>
          `;
          corpo.appendChild(linha);
        });
      });

      bairrosRef.on('value', (snapshot) => {
        const corpo = document.querySelector("#tabela-bairros-tecnico tbody");
        corpo.innerHTML = '';
        
        if (!snapshot.exists()) {
          document.getElementById('loading-bairros-tecnico').textContent = 'Nenhum bairro cadastrado.';
          return;
        }
        
        document.getElementById('loading-bairros-tecnico').style.display = 'none';
        
        snapshot.forEach((child) => {
          const bairro = child.val();
          const atrasado = bairro.status === 'Em manutenção' && verificarManutencaoAtrasada(bairro.previsaoTermino);
          const statusClass = bairro.status === 'Normal' ? 'success' : 
                            atrasado ? 'danger' : 'warning';
          
          const linha = document.createElement('tr');
          linha.innerHTML = `
            <td>${bairro.nome}</td>
            <td>${bairro.cidade}</td>
            <td>
              <button class="${statusClass}">${bairro.status}</button>
              ${bairro.status === 'Em manutenção' && bairro.previsaoTermino ? 
                `<div class="status-info ${atrasado ? 'status-overdue' : ''}">
                  Previsão: ${formatarDataHora(bairro.previsaoTermino)}
                  ${atrasado ? ' (Atrasada)' : ''}
                </div>` : ''}
            </td>
            <td>
              <button onclick='editarStatusBairro("${child.key}", ${JSON.stringify(bairro).replace(/"/g, '&quot;')})'>Editar Status</button>
            </td>
          `;
          corpo.appendChild(linha);
        });
      });
    }

    // Função para filtrar CTOs (técnico)
    function filtrarCTOsTecnico() {
      const status = document.getElementById('filtro-status-cto-tecnico').value;
      const linhas = document.querySelectorAll("#tabela-ctos-tecnico tbody tr");
      
      linhas.forEach(linha => {
        const linhaStatus = linha.cells[3].querySelector('button').textContent;
        if (status === "Todos" || linhaStatus === status) {
          linha.style.display = "";
        } else {
          linha.style.display = "none";
        }
      });
    }

    // Função para filtrar bairros (técnico)
    function filtrarBairrosTecnico() {
      const status = document.getElementById('filtro-status-bairro-tecnico').value;
      const linhas = document.querySelectorAll("#tabela-bairros-tecnico tbody tr");
      
      linhas.forEach(linha => {
        const linhaStatus = linha.cells[2].querySelector('button').textContent;
        if (status === "Todos" || linhaStatus === status) {
          linha.style.display = "";
        } else {
          linha.style.display = "none";
        }
      });
    }

    // Função para abrir o mapa
    function abrirMapa(nome, lat, lng) {
      document.getElementById('map-titulo').innerText = nome;
      document.getElementById('map-modal').style.display = 'block';
      
      // Destrói o mapa existente se houver
      if (map) {
        map.remove();
      }
      
      // Cria um novo mapa
      setTimeout(() => {
        map = L.map('map').setView([lat, lng], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        L.marker([lat, lng]).addTo(map)
          .bindPopup(nome)
          .openPopup();
      }, 100);
    }

    // Função para fechar modal
    function fecharModal(id) {
      document.getElementById(id).style.display = 'none';
      if (id === 'map-modal' && map) {
        map.remove();
        map = null;
      }
    }

    // Função para abrir tabs
    function openTab(tabId) {
      // Esconde todos os conteúdos de tab
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove a classe active de todos os botões
      document.querySelectorAll('.tab-buttons button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Mostra a tab selecionada e marca o botão como ativo
      document.getElementById(tabId).classList.add('active');
      event.currentTarget.classList.add('active');
    }

    // Função para exibir mensagens de erro
    function showError(element, message) {
      element.textContent = message;
      element.style.display = 'block';
    }

    // Inicialização da página
    window.onload = () => {
      document.getElementById('login-section').style.display = 'block';
      
      // Verifica se o usuário já está logado
      auth.onAuthStateChanged((user) => {
        if (user) {
          document.getElementById('login-section').style.display = 'none';
          if (supervisorEmails.includes(user.email)) {
            document.getElementById('supervisor-section').style.display = 'block';
            carregarTabelasSupervisor();
          } else if (atendenteEmails.includes(user.email)) {
            document.getElementById('atendente-section').style.display = 'block';
            carregarTabelasAtendente();
          } else if (tecnicoEmails.includes(user.email)) {
            document.getElementById('tecnico-section').style.display = 'block';
            carregarTabelasTecnico();
          } else {
            logout();
          }
        }
      });
    };
  </script>
</body>
</html>
